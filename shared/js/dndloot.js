function e(e){let t=e.getThemeData(),n=e.getDarkMode(),a=document.getElementById("chat-theme-style");a||((a=document.createElement("style")).id="chat-theme-style",document.head.appendChild(a));let o=n?t.darkHeaderBg:t.headerBg,s=n?t.darkOutgoingBubbleBg:t.outgoingBubbleBg;a.textContent=`
    .chat-header {
      background: ${o};
    }
    .message-outgoing {
      background: ${s};
    }
    #send-btn {
      background-color: ${o.split(",")[1].trim()};
    }
  `}const t={"zh-CN":{appTitle:"P2P安全群聊",appDescription:"端到端加密，无服务器，完全隐私",nicknameLabel:"设置昵称",nicknamePlaceholder:"请输入您的昵称",createRoom:"创建群聊",joinRoom:"加入群聊",settings:"设置",darkMode:"深色模式",lightMode:"浅色模式",enterMessage:"输入消息...",roomCode:"群聊码",enterRoomCode:"请输入群聊码",cancel:"取消",confirm:"确认",language:"语言",privacyPolicy:"隐私政策",privacyPolicyText:"本应用采用点对点通信技术，不会在任何服务器上存储您的通信内容。所有消息都经过端到端加密，只有参与对话的成员才能解密查看。我们不收集任何个人识别信息，您的隐私和安全是我们的首要任务。",about:"关于",version:"版本",versionNumber:"1.0.0",appDescription2:"基于PeerJS的去中心化即时通讯应用",roomName:"群聊名称",roomCodeLabel:"群聊码",leaveRoom:"退出群聊",webrtcWarningTitle:"WebRTC不可用",webrtcWarningText:"您的浏览器未启用WebRTC功能，这是本应用正常运行所必需的。请启用WebRTC后刷新页面。",understand:"了解",onlineUsers:"在线用户",onlineCount:"在线人数",roomSettings:"群聊设置",lowMemberWarning:"当在线人数不足3人时，群聊将在最后一人退出后被摧毁",copy:"复制",enterNickname:"请输入昵称",createRoomFailed:"创建群聊失败，请重试",joinRoomFailed:"加入群聊失败，请检查群聊码是否正确",sendingMessage:"发送中...",messageError:"消息发送失败，请重试",sending:"发送中",recording:"录音中...",clickToPlay:"点击播放",clickToPause:"点击暂停",you:"你",typing:"正在输入...",copiedToClipboard:"已复制到剪贴板!",connecting:"连接中...",connectionFailed:"连接失败",userJoined:"已加入群聊",userLeft:"已离开群聊",seconds:"秒",unknownFile:"未知文件类型",fileTooBig:"文件太大，不能超过20MB",newMessage:"新消息",noMessages:"暂无消息"},en:{appTitle:"P2P Secure Chat",appDescription:"End-to-end encrypted, serverless, completely private",nicknameLabel:"Set Nickname",nicknamePlaceholder:"Enter your nickname",createRoom:"Create Chat",joinRoom:"Join Chat",settings:"Settings",darkMode:"Dark Mode",lightMode:"Light Mode",enterMessage:"Type a message...",roomCode:"Chat Code",enterRoomCode:"Enter chat code",cancel:"Cancel",confirm:"Confirm",language:"Language",privacyPolicy:"Privacy Policy",privacyPolicyText:"This application uses peer-to-peer communication technology and does not store your communication content on any server. All messages are end-to-end encrypted, and only members participating in the conversation can decrypt and view them. We do not collect any personally identifiable information. Your privacy and security are our top priorities.",about:"About",version:"Version",versionNumber:"1.0.0",appDescription2:"Decentralized instant messaging app based on PeerJS",roomName:"Chat Name",roomCodeLabel:"Chat Code",leaveRoom:"Leave Chat",webrtcWarningTitle:"WebRTC Unavailable",webrtcWarningText:"Your browser does not have WebRTC enabled, which is necessary for this application to function properly. Please enable WebRTC and refresh the page.",understand:"Understand",onlineUsers:"Online Users",onlineCount:"Online Users",roomSettings:"Chat Settings",lowMemberWarning:"When there are fewer than 3 people online, the chat will be destroyed after the last person leaves",copy:"Copy",enterNickname:"Please enter a nickname",createRoomFailed:"Failed to create chat room, please try again",joinRoomFailed:"Failed to join the chat, please check the chat code",sendingMessage:"Sending...",messageError:"Failed to send message, please try again",sending:"Sending",recording:"Recording...",clickToPlay:"Click to play",clickToPause:"Click to pause",you:"You",typing:"typing...",copiedToClipboard:"Copied to clipboard!",connecting:"Connecting...",connectionFailed:"Connection failed",userJoined:"joined the chat",userLeft:"left the chat",seconds:"seconds",unknownFile:"Unknown file type",fileTooBig:"File is too large, maximum is 20MB",newMessage:"New message",noMessages:"No messages yet"}};let n="zh-CN";function a(e){return(t[n]||t["zh-CN"])[e]||e}class o{static formatFileSize(e){if(0===e)return"0 B";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}static getFileIcon(e){return({jpg:"fa-file-image",jpeg:"fa-file-image",png:"fa-file-image",gif:"fa-file-image",webp:"fa-file-image",svg:"fa-file-image",mp4:"fa-file-video",webm:"fa-file-video",avi:"fa-file-video",mov:"fa-file-video",mkv:"fa-file-video",mp3:"fa-file-audio",wav:"fa-file-audio",ogg:"fa-file-audio",m4a:"fa-file-audio",pdf:"fa-file-pdf",doc:"fa-file-word",docx:"fa-file-word",xls:"fa-file-excel",xlsx:"fa-file-excel",ppt:"fa-file-powerpoint",pptx:"fa-file-powerpoint",txt:"fa-file-alt",zip:"fa-file-archive",rar:"fa-file-archive","7z":"fa-file-archive",tar:"fa-file-archive",gz:"fa-file-archive",html:"fa-file-code",css:"fa-file-code",js:"fa-file-code",json:"fa-file-code",php:"fa-file-code",py:"fa-file-code",java:"fa-file-code",c:"fa-file-code",cpp:"fa-file-code",cs:"fa-file-code",rb:"fa-file-code"})[e.split(".").pop().toLowerCase()]||"fa-file"}static isImage(e){return["jpg","jpeg","png","gif","webp","svg"].includes(e.split(".").pop().toLowerCase())}static isVideo(e){return["mp4","webm","avi","mov","mkv"].includes(e.split(".").pop().toLowerCase())}static isAudio(e){return["mp3","wav","ogg","m4a"].includes(e.split(".").pop().toLowerCase())}static async getLinkPreview(e){try{return{title:e.replace(/^https?:\/\//,"").split("/")[0],description:"链接预览内容...",image:"",url:e}}catch(t){return console.error("获取链接预览失败:",t),{title:e.replace(/^https?:\/\//,"").split("/")[0],description:"",image:"",url:e}}}static fileToBase64(e){return new Promise((t,n)=>{let a=new FileReader;a.readAsDataURL(e),a.onload=()=>t(a.result),a.onerror=e=>n(e)})}static extractUrls(e){return e.match(/(https?:\/\/[^\s]+)/g)||[]}static async recordVoice(){return new Promise(async(e,t)=>{try{let t=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(t),a=[],o=Date.now();return n.addEventListener("dataavailable",e=>{a.push(e.data)}),n.addEventListener("stop",()=>{let n=Math.round((Date.now()-o)/1e3),s=new Blob(a,{type:"audio/webm"});t.getTracks().forEach(e=>e.stop()),e({blob:s,duration:n})}),n.start(),{stop:()=>{"inactive"!==n.state&&n.stop()}}}catch(e){console.error("录制语音失败:",e),t(e)}})}static createVoiceMessageElement(e,t){let n=document.createElement("div");n.className="voice-message";let a=document.createElement("i");a.className="fas fa-play";let o=document.createElement("audio");o.src=e;let s=document.createElement("span");s.className="duration",s.textContent=`${t}\u{79D2}`,n.appendChild(a),n.appendChild(s);let i=!1;return n.addEventListener("click",()=>{i?(o.pause(),a.className="fas fa-play"):(o.play(),a.className="fas fa-pause"),i=!i}),o.addEventListener("ended",()=>{a.className="fas fa-play",i=!1}),n}static base64ToBlob(e,t){let n=atob(e.split(",")[1]),a=[];for(let e=0;e<n.length;e+=512){let t=n.slice(e,e+512),o=Array(t.length);for(let e=0;e<t.length;e++)o[e]=t.charCodeAt(e);let s=new Uint8Array(o);a.push(s)}return new Blob(a,{type:t})}}class s{static STICKER_APIS=["https://uapis.cn/api/imgapi/bq/maomao.php","https://uapis.cn/api/imgapi/bq/eciyuan.php"];static FALLBACK_STICKERS=[{url:"https://uapis.cn/api/imgapi/bq/maomao.php"},{url:"https://uapis.cn/api/imgapi/bq/eciyuan.php"}];static currentApiIndex=0;static lastRefreshTime=0;static REFRESH_COOLDOWN=5e3;static cachedStickers=[];static cachedImageData={};static isFirstLoad=!0;static canRefresh(){return Date.now()-this.lastRefreshTime>this.REFRESH_COOLDOWN}static getCooldownRemaining(){let e=Date.now()-this.lastRefreshTime;return Math.ceil(Math.max(0,this.REFRESH_COOLDOWN-e)/1e3)}static async cacheImageAsBase64(e){return this.cachedImageData[e]?this.cachedImageData[e]:new Promise((t,n)=>{try{let a=new XMLHttpRequest;a.onload=()=>{let o=new FileReader;o.onloadend=()=>{this.cachedImageData[e]=o.result,t(o.result)},o.onerror=n,o.readAsDataURL(a.response)},a.onerror=()=>{console.warn(`\u{52A0}\u{8F7D}\u{56FE}\u{7247}\u{5931}\u{8D25}: ${e}`),t(e)},a.open("GET",e),a.responseType="blob",a.timeout=5e3,a.ontimeout=()=>{console.warn(`\u{52A0}\u{8F7D}\u{56FE}\u{7247}\u{8D85}\u{65F6}: ${e}`),t(e)},a.send()}catch(n){console.error("缓存图片失败:",n),t(e)}})}static async fetchStickers(){try{this.lastRefreshTime=Date.now();let e=[];for(let t of this.STICKER_APIS)try{console.log("正在从API获取表情包:",t);let n=[];for(let e=0;e<10;e++){let e=`${Date.now()}-${Math.random()}`,a=`${t}?t=${e}`,o=await this.cacheImageAsBase64(a);n.push({url:o,originalUrl:a,id:`sticker-${e}`})}e=[...e,...n]}catch(e){console.warn(`\u{4ECE}API ${t} \u{83B7}\u{53D6}\u{8868}\u{60C5}\u{5305}\u{5931}\u{8D25}:`,e)}return 0===e.length&&(console.log("未能从API获取表情包，使用备用表情包"),e=await Promise.all(this.FALLBACK_STICKERS.map(async e=>{let t=`fallback-${Date.now()}-${Math.random()}`,n=`${e.url}?t=${t}`;return{url:await this.cacheImageAsBase64(n),originalUrl:n,id:`sticker-fallback-${t}`}}))),this.cachedStickers=e,this.isFirstLoad=!1,e}catch(e){if(console.error("获取表情包失败:",e),this.isFirstLoad)return this.isFirstLoad=!1,await Promise.all(this.FALLBACK_STICKERS.map(async e=>{let t=`error-fallback-${Date.now()}-${Math.random()}`,n=`${e.url}?t=${t}`;return{url:await this.cacheImageAsBase64(n),originalUrl:n,id:`sticker-error-${t}`}}));return this.cachedStickers.length>0?this.cachedStickers:this.FALLBACK_STICKERS}}}class i{constructor(e){this.key=e}setKey(e){this.key=e}async encrypt(e){try{let t=JSON.stringify(e),n=this.hexStringToArrayBuffer(this.key),a=await this.generateKey(n),o=window.crypto.getRandomValues(new Uint8Array(12)),s=new TextEncoder().encode(t),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},a,s),r={iv:Array.from(o).map(e=>e.toString(16).padStart(2,"0")).join(""),ciphertext:this.arrayBufferToBase64(i)};return JSON.stringify(r)}catch(e){return console.error("加密失败:",e),null}}async decrypt(e){try{let{iv:t,ciphertext:n}=JSON.parse(e),a=this.hexStringToArrayBuffer(this.key),o=await this.generateKey(a),s=this.hexStringToArrayBuffer(t),i=this.base64ToArrayBuffer(n),r=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s},o,i),c=new TextDecoder().decode(r);return JSON.parse(c)}catch(e){return console.error("解密失败:",e),null}}async generateKey(e){return await window.crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}hexStringToArrayBuffer(e){let t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substr(n,2),16);return t.buffer}arrayBufferToBase64(e){let t=new Uint8Array(e),n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return window.btoa(n)}base64ToArrayBuffer(e){let t=window.atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}}class r{constructor(){this.peer=null,this.connections={},this.roomId=null,this.encryption=null,this.encryptionKey=null,this.userId=null,this.nickname=null,this.roomName=null,this.messageCallbacks=[],this.connectionCallbacks=[],this.disconnectionCallbacks=[],this.connectionStatus=!1,this.pageHidden=!1,this.isHostMode=!1,this.isRoomCreator=!1,this.initVisibilityListener()}initVisibilityListener(){document.addEventListener("visibilitychange",()=>{let e=this.pageHidden;this.pageHidden="hidden"===document.visibilityState,e&&!this.pageHidden&&this.roomId&&this.reconnectIfNeeded()})}async initialize(e,t){return new Promise((n,a)=>{try{this.nickname=e,this.encryptionKey=t,this.encryption=new i(t),this.connectionStatus=!1,this.peer=new Peer({debug:0,config:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}}),this.peer.on("open",e=>{this.userId=e,console.log("PeerJS连接成功，ID:",e),this.setupConnectionListeners(),n(e)}),this.peer.on("error",e=>{console.error("PeerJS错误:",e),"peer-unavailable"===e.type?console.warn("目标用户不可用，可能离线或ID无效"):a(e)}),this.peer.on("disconnected",()=>{console.log("PeerJS与服务器断开连接"),this.pageHidden||(this.connectionStatus=!1,setTimeout(()=>{!this.peer||this.isConnected()||this.pageHidden||(console.log("尝试重新连接到PeerJS服务器"),this.peer.reconnect())},3e3))}),this.peer.on("close",()=>{console.log("PeerJS连接关闭"),this.pageHidden||(this.connectionStatus=!1)})}catch(e){console.error("初始化PeerJS失败:",e),a(e)}})}isConnected(){return null!==this.roomId&&(this.connectionStatus||Object.keys(this.connections).length>0)}setupConnectionListeners(){this.peer.on("connection",e=>{console.log("收到新连接:",e.peer),e.on("open",()=>{this.connections[e.peer]=e,this.connectionStatus=!0,this.setupConnectionEvents(e),this.sendUserInfo(e),this.connectionCallbacks.forEach(t=>{t({userId:e.peer,type:"user-joined"})})})})}setupConnectionEvents(e){e.on("data",async t=>{try{let n=await this.encryption.decrypt(t);if(n)switch(n.type){case"chat":this.messageCallbacks.forEach(e=>{e(n,t)});break;case"user-info":this.handleUserInfo(e.peer,n);break;case"request-history":this.handleHistoryRequest(e);break;case"history":this.handleHistory(n);break;case"reaction":this.messageCallbacks.forEach(e=>{e(n)});break;case"room-info":this.handleRoomInfo(n);break;case"host-mode":void 0!==n.enabled&&(!0===n.fromCreator?(this.isHostMode=n.enabled,console.log(`\u{4E3B}\u{6301}\u{4EBA}\u{6A21}\u{5F0F}\u{5DF2}${n.enabled?"开启":"关闭"}`),this.messageCallbacks.forEach(e=>{e(n)})):console.warn("收到非群主发送的主持人模式设置，已忽略"))}}catch(e){console.error("处理接收数据失败:",e)}}),e.on("close",()=>{console.log("连接断开:",e.peer),!this.pageHidden&&(delete this.connections[e.peer],0===Object.keys(this.connections).length&&(this.connectionStatus=!1),this.pageHidden||this.disconnectionCallbacks.forEach(t=>{t({userId:e.peer,type:"user-left"})}))}),e.on("error",t=>{console.error("连接错误:",t),!this.pageHidden&&(delete this.connections[e.peer],0===Object.keys(this.connections).length&&(this.connectionStatus=!1),this.pageHidden||this.disconnectionCallbacks.forEach(t=>{t({userId:e.peer,type:"user-left",error:!0})}))})}createRoom(){let e="g-"+this.generateRandomRoomCode(6);return this.roomId=e,this.roomName="新加密群聊",this.isRoomCreator=!0,this.savePeerMapping(e,this.userId),console.log("保存映射关系:",e,"->",this.userId),e}generateRandomRoomCode(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n="";for(let a=0;a<e;a++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}async joinRoom(e){return new Promise((t,n)=>{try{let a;if(this.isRoomCreator=!1,!e.startsWith("g-"))return void n(Error("无效的群聊ID，格式不正确"));if(e.length<=8){if(!(a=this.getPeerMap()[e]))return void n(Error("无法找到该群聊，可能已解散"))}else a=e.substring(2);console.log("尝试连接到目标用户:",a);let o=this.peer.connect(a,{reliable:!0});o.on("open",()=>{console.log("成功连接到目标用户:",a),this.connections[o.peer]=o,this.connectionStatus=!0,this.setupConnectionEvents(o),this.roomId=e,this.sendUserInfo(o),this.requestHistory(o),t(!0)}),o.on("error",e=>{console.error("连接目标用户失败:",e),n(e)})}catch(e){console.error("加入群聊失败:",e),n(e)}})}getPeerMap(){try{let e=localStorage.getItem("peerIdMap"),t=e?JSON.parse(e):{};return console.log("当前Peer映射表:",t),t}catch(e){return console.error("获取Peer映射表失败:",e),{}}}savePeerMapping(e,t){try{let n=this.getPeerMap();n[e]=t,localStorage.setItem("peerIdMap",JSON.stringify(n)),console.log(`\u{6620}\u{5C04}\u{5DF2}\u{4FDD}\u{5B58}: ${e} -> ${t}`)}catch(e){console.error("保存Peer映射失败:",e)}}async sendMessage(e){try{if(this.isHostMode&&!this.isRoomCreator)return console.log("主持人模式已启用，只有群主可以发送消息"),{error:"主持人模式已启用，只有群主可以发送消息"};let t={...e,sender:{id:this.userId,nickname:this.nickname},timestamp:Date.now(),type:"chat"},n=await this.encryption.encrypt(t),a=null;if("text"===e.contentType)try{a=JSON.parse(n).ciphertext.substring(0,20)+"..."}catch(e){a=JSON.stringify(n).substring(0,20)+"..."}return Object.values(this.connections).forEach(e=>{e.send(n)}),this.messageCallbacks.forEach(e=>{e(t,n)}),{message:t,encryptedPreview:a,encryptedData:n}}catch(e){return console.error("发送消息失败:",e),null}}async sendUserInfo(e){try{let t={type:"user-info",userId:this.userId,nickname:this.nickname,avatar:this.getAvatarUrl(this.nickname)},n=await this.encryption.encrypt(t);if(e.send(n),this.isRoomCreator&&this.isHostMode){console.log("向新用户通知主持人模式状态");let t=await this.encryption.encrypt({type:"host-mode",enabled:!0,fromCreator:!0});e.send(t)}}catch(e){console.error("发送用户信息失败:",e)}}async requestHistory(e){try{let t=await this.encryption.encrypt({type:"request-history"});e.send(t)}catch(e){console.error("请求历史消息失败:",e)}}async handleHistoryRequest(e){try{let t=null,n=this.messageCallbacks.filter(e=>"function"==typeof e.getHistory);if(n.length>0&&(t=n[0].getHistory()),t){let n={type:"history",data:t,roomInfo:{roomId:this.roomId,roomName:this.roomName}},a=await this.encryption.encrypt(n);e.send(a)}}catch(e){console.error("处理历史消息请求失败:",e)}}handleHistory(e){try{e.roomInfo&&(this.roomName=e.roomInfo.roomName),this.messageCallbacks.forEach(t=>{"function"==typeof t.setHistory&&t.setHistory(e.data)})}catch(e){console.error("处理历史消息失败:",e)}}handleUserInfo(e,t){this.connectionCallbacks.forEach(n=>{"function"==typeof n.updateUserInfo&&n.updateUserInfo({userId:e,nickname:t.nickname,avatar:t.avatar})})}handleRoomInfo(e){e.roomName&&(this.roomName=e.roomName,this.connectionCallbacks.forEach(t=>{"function"==typeof t.updateRoomInfo&&t.updateRoomInfo({roomName:e.roomName})}))}async setRoomName(e){try{this.roomName=e;let t=await this.encryption.encrypt({type:"room-info",roomName:e});return Object.values(this.connections).forEach(e=>{e.send(t)}),!0}catch(e){return console.error("设置群聊名称失败:",e),!1}}async sendReaction(e,t,n){try{if(this.isHostMode&&!this.isRoomCreator)return console.log("主持人模式已启用，只有群主可以发送消息"),{error:"主持人模式已启用，只有群主可以发送消息"};let a={type:"reaction",messageId:e,emoji:t,userId:this.userId,add:n},o=await this.encryption.encrypt(a);return Object.values(this.connections).forEach(e=>{e.send(o)}),this.messageCallbacks.forEach(e=>{e(a)}),a}catch(e){return console.error("发送反应失败:",e),null}}onMessage(e){this.messageCallbacks.push(e)}onConnection(e){this.connectionCallbacks.push(e)}onDisconnection(e){this.disconnectionCallbacks.push(e)}leaveRoom(e=!0){(!this.pageHidden||e)&&(Object.values(this.connections).forEach(e=>{e.close()}),this.connections={},this.connectionStatus=!1,this.roomId=null,this.roomName=null)}getConnectionCount(){return Object.keys(this.connections).length}getGroupAvatarUrl(e){return`https://api.dicebear.com/9.x/bottts-neutral/svg?seed=${e}`}getAvatarUrl(e){return`https://api.dicebear.com/9.x/adventurer/svg?seed=${e}`}getRoomId(){return this.roomId}getUserId(){return this.userId}getRoomName(){return this.roomName}setNickname(e){this.nickname=e}getNickname(){return this.nickname}async reconnectIfNeeded(){if(this.roomId&&!this.isConnected()&&this.peer){if(this.peer.disconnected)try{this.peer.reconnect()}catch(e){console.warn("重连服务器失败，可能是连接没有断开:",e.message)}await new Promise(e=>setTimeout(e,2e3));let e=Object.keys(this.connections);e.length>0&&e.forEach(e=>{if(!this.connections[e].open){let t=this.peer.connect(e,{reliable:!0});t&&(this.connections[e]=t,this.setupConnectionEvents(t))}})}}async setHostMode(e){try{if(!this.isRoomCreator)return console.warn("只有群主才能设置主持人模式"),!1;let t={type:"host-mode",enabled:e,fromCreator:!0};this.isHostMode=e;let n=await this.encryption.encrypt(t);return Object.values(this.connections).forEach(e=>{e.send(n)}),this.messageCallbacks.forEach(e=>{e(t)}),console.log(`\u{4E3B}\u{6301}\u{4EBA}\u{6A21}\u{5F0F}\u{5DF2}${e?"开启":"关闭"}`),!0}catch(e){return console.error("设置主持人模式失败:",e),!1}}getHostMode(){return this.isHostMode}isCreator(){return this.isRoomCreator}}const c=document.getElementById("home-page"),l=document.getElementById("chat-page"),d=document.getElementById("settings-page"),m=document.getElementById("room-settings-page"),u=document.getElementById("webrtc-warning"),g=new class{constructor(){this.keys={nickname:"nickname",darkMode:"darkMode",language:"language",encryption:"encryption",lastRoomId:"lastRoomId",lastRoomName:"lastRoomName",chatTheme:"chatTheme",lastConnectionAttempt:"lastConnectionAttempt",connectionAttemptCount:"connectionAttemptCount"},this.availableThemes={default:{name:"默认蓝",headerBg:"linear-gradient(90deg, #1e40af, #3b82f6)",darkHeaderBg:"linear-gradient(90deg, #1e3a8a, #2563eb)",outgoingBubbleBg:"linear-gradient(135deg, #00b0ff, #2979ff)",darkOutgoingBubbleBg:"linear-gradient(135deg, #0277bd, #1565c0)"},green:{name:"清新绿",headerBg:"linear-gradient(90deg, #065f46, #10b981)",darkHeaderBg:"linear-gradient(90deg, #064e3b, #059669)",outgoingBubbleBg:"linear-gradient(135deg, #34d399, #10b981)",darkOutgoingBubbleBg:"linear-gradient(135deg, #059669, #047857)"},purple:{name:"梦幻紫",headerBg:"linear-gradient(90deg, #6d28d9, #8b5cf6)",darkHeaderBg:"linear-gradient(90deg, #5b21b6, #7c3aed)",outgoingBubbleBg:"linear-gradient(135deg, #a78bfa, #8b5cf6)",darkOutgoingBubbleBg:"linear-gradient(135deg, #7c3aed, #6d28d9)"},red:{name:"热情红",headerBg:"linear-gradient(90deg, #b91c1c, #ef4444)",darkHeaderBg:"linear-gradient(90deg, #991b1b, #dc2626)",outgoingBubbleBg:"linear-gradient(135deg, #f87171, #ef4444)",darkOutgoingBubbleBg:"linear-gradient(135deg, #dc2626, #b91c1c)"},dark:{name:"暗夜黑",headerBg:"linear-gradient(90deg, #111827, #1f2937)",darkHeaderBg:"linear-gradient(90deg, #030712, #111827)",outgoingBubbleBg:"linear-gradient(135deg, #374151, #1f2937)",darkOutgoingBubbleBg:"linear-gradient(135deg, #1f2937, #111827)"}}}getNickname(){let e=localStorage.getItem(this.keys.nickname);return e||(localStorage.getItem("hasGeneratedNickname")||(localStorage.setItem("hasGeneratedNickname","true"),this.generateAndSaveNickname()),"游客")}async generateAndSaveNickname(){try{let e=await fetch("https://api.uomg.com/api/rand.nickname?format=json",{timeout:3e3}),t=await e.json();if(1===t.code&&t.nickName){let e=t.nickName;this.setNickname(e),this.dispatchNicknameEvent(e);return}console.warn("API生成昵称失败，使用本地生成"),this.generateLocalNickname()}catch(e){console.error("生成昵称时出错:",e),this.generateLocalNickname()}}generateLocalNickname(){let e=["快乐","勇敢","聪明","善良","温柔","活泼","可爱","睿智","幽默","热心"],t=["旅行者","探险家","梦想家","思考者","创造者","冒险家","观察者","收藏家","指挥家","守护者"],n=e[Math.floor(Math.random()*e.length)],a=t[Math.floor(Math.random()*t.length)],o=Math.floor(1e3*Math.random()),s=`${n}${a}${o}`;this.setNickname(s),this.dispatchNicknameEvent(s)}dispatchNicknameEvent(e){let t=new CustomEvent("nicknameGenerated",{detail:{nickname:e}});document.dispatchEvent(t);let n=document.getElementById("nickname");n&&(n.value=e)}setNickname(e){localStorage.setItem(this.keys.nickname,e)}getDarkMode(){return"true"===localStorage.getItem(this.keys.darkMode)}setDarkMode(e){localStorage.setItem(this.keys.darkMode,e)}getLanguage(){return localStorage.getItem(this.keys.language)||"zh-CN"}setLanguage(e){localStorage.setItem(this.keys.language,e)}getEncryptionKey(){let e=localStorage.getItem(this.keys.encryption);return e||(e=this.generateEncryptionKey(),this.setEncryptionKey(e)),e}setEncryptionKey(e){localStorage.setItem(this.keys.encryption,e)}generateEncryptionKey(){let e=new Uint8Array(32);return window.crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}saveLastRoom(e,t){e&&(localStorage.setItem(this.keys.lastRoomId,e),localStorage.setItem(this.keys.lastRoomName,t||"群聊"),this.resetConnectionAttempts())}getLastRoom(){let e=localStorage.getItem(this.keys.lastRoomId);return e?{roomId:e,roomName:localStorage.getItem(this.keys.lastRoomName)||"群聊"}:null}clearLastRoom(){localStorage.removeItem(this.keys.lastRoomId),localStorage.removeItem(this.keys.lastRoomName),this.resetConnectionAttempts()}recordConnectionAttempt(){let e=Date.now();localStorage.setItem(this.keys.lastConnectionAttempt,e);let t=this.getConnectionAttemptCount();localStorage.setItem(this.keys.connectionAttemptCount,t+1)}getLastConnectionAttempt(){return parseInt(localStorage.getItem(this.keys.lastConnectionAttempt)||"0")}getConnectionAttemptCount(){return parseInt(localStorage.getItem(this.keys.connectionAttemptCount)||"0")}resetConnectionAttempts(){localStorage.removeItem(this.keys.lastConnectionAttempt),localStorage.removeItem(this.keys.connectionAttemptCount)}shouldAttemptReconnection(){let e=this.getConnectionAttemptCount(),t=this.getLastConnectionAttempt(),n=Date.now();return e<5||n-t>3e5}getChatTheme(){return localStorage.getItem(this.keys.chatTheme)||"default"}setChatTheme(e){localStorage.setItem(this.keys.chatTheme,e)}getThemeData(e){let t=e||this.getChatTheme();return this.availableThemes[t]||this.availableThemes.default}getAllThemes(){return this.availableThemes}getChatHistoryKey(){return"chatHistory"}saveChatToHistory(e,t){if(!e)return;let n=this.getChatHistoryKey(),a=JSON.parse(localStorage.getItem(n)||"[]"),o=a.findIndex(t=>t.roomId===e),s=Date.now();o>=0?(a[o].lastActive=s,a[o].roomName=t||a[o].roomName):a.push({roomId:e,roomName:t||"群聊",joinTime:s,lastActive:s}),a.sort((e,t)=>t.lastActive-e.lastActive),a.length>10&&(a=a.slice(0,10)),localStorage.setItem(n,JSON.stringify(a))}updateChatLastActive(e){if(!e)return;let t=this.getChatHistoryKey(),n=JSON.parse(localStorage.getItem(t)||"[]"),a=n.findIndex(t=>t.roomId===e);a>=0&&(n[a].lastActive=Date.now(),n.sort((e,t)=>t.lastActive-e.lastActive),localStorage.setItem(t,JSON.stringify(n)))}getChatHistory(){let e=this.getChatHistoryKey();return JSON.parse(localStorage.getItem(e)||"[]")}removeChatFromHistory(e){if(!e)return;let t=this.getChatHistoryKey(),n=JSON.parse(localStorage.getItem(t)||"[]");n=n.filter(t=>t.roomId!==e),localStorage.setItem(t,JSON.stringify(n))}},h=g.getLanguage()||"zh-CN",p=g.getDarkMode(),y=new class{constructor(){this.messages=[],this.reactions={},this.currentRoomId=null}initializeRoom(e){this.currentRoomId=e,this.messages=[],this.reactions={}}addMessage(e,t){return e.id||(e.id=this.generateMessageId()),t&&(e.encryptedData=t),this.messages.push(e),e}getAllMessages(){return[...this.messages]}getMessage(e){return this.messages.find(t=>t.id===e)||null}addReaction(e,t,n){return this.reactions[e]||(this.reactions[e]={}),this.reactions[e][t]||(this.reactions[e][t]=new Set),this.reactions[e][t].add(n),{messageId:e,emoji:t,count:this.reactions[e][t].size}}removeReaction(e,t,n){return this.reactions[e]&&this.reactions[e][t]?(this.reactions[e][t].delete(n),0===this.reactions[e][t].size&&(delete this.reactions[e][t],0===Object.keys(this.reactions[e]).length))?(delete this.reactions[e],null):{messageId:e,emoji:t,count:this.reactions[e][t]?.size||0}:null}getMessageReactions(e){let t={};return this.reactions[e]&&Object.keys(this.reactions[e]).forEach(n=>{t[n]=this.reactions[e][n].size}),t}generateMessageId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}hasUserReacted(e,t,n){return this.reactions[e]&&this.reactions[e][t]&&this.reactions[e][t].has(n)}clearMessages(){this.messages=[],this.reactions={},this.currentRoomId=null}exportData(){let e={};return Object.keys(this.reactions).forEach(t=>{e[t]={},Object.keys(this.reactions[t]).forEach(n=>{e[t][n]=Array.from(this.reactions[t][n])})}),{messages:this.messages,reactions:e}}importData(e){e&&(e.messages&&(this.messages=e.messages),e.reactions&&(this.reactions={},Object.keys(e.reactions).forEach(t=>{this.reactions[t]={},Object.keys(e.reactions[t]).forEach(n=>{this.reactions[t][n]=new Set(e.reactions[t][n])})})))}},f=new r;!function(){let e="RTCPeerConnection"in window||"webkitRTCPeerConnection"in window||"mozRTCPeerConnection"in window,t=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);return e&&t}()&&(u.classList.remove("hidden"),document.getElementById("webrtc-ok").addEventListener("click",()=>{u.classList.add("hidden")}));p?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark");const v=document.getElementById("toggle-theme");v&&v.addEventListener("click",()=>{document.documentElement.classList.toggle("dark");let e=document.documentElement.classList.contains("dark"),t=document.getElementById("settings-toggle-theme");return t&&(t.classList.toggle("dark:bg-blue-600",e),t.querySelector("span").classList.toggle("dark:left-5",e)),e}),e(g),document.addEventListener("DOMContentLoaded",()=>{let t=document.getElementById("toggle-theme");t&&t.addEventListener("click",()=>{let t=document.documentElement.classList.contains("dark");g.setDarkMode(t),e(g)})}),function e(t){n=t,localStorage.setItem("language",t);let a=document.getElementById("language-select");a&&(a.value=t,a.addEventListener("change",t=>{e(t.target.value),window.location.reload()}))}(h),function(t,n,o,s){let i=document.getElementById("nickname"),r=document.getElementById("create-room-btn"),c=document.getElementById("join-room-btn"),l=document.getElementById("join-room-modal"),d=document.getElementById("room-code"),m=document.getElementById("confirm-join"),u=document.getElementById("cancel-join"),g=document.getElementById("settings-btn"),h=document.getElementById("settings-page"),p=document.querySelector("#home-page .w-full.max-w-md"),y=document.getElementById("chat-history-container"),f=document.getElementById("chat-history-list"),v=document.getElementById("toggle-history");function b(){let e=s.getLastRoom();if(e&&e.roomId&&!document.querySelector("#confirm-rejoin")){if(!s.shouldAttemptReconnection())return void console.log("已达到最大重连尝试次数或间隔时间不足，跳过重连提示");s.recordConnectionAttempt();let t=document.createElement("div");t.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm",t.id="confirm-rejoin-modal",t.innerHTML=`
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md transform transition-all duration-300 scale-100">
          <h2 class="text-xl font-bold mb-4">\u{91CD}\u{65B0}\u{52A0}\u{5165}\u{7FA4}\u{804A}</h2>
          <p class="mb-4">\u{4F60}\u{4E0A}\u{6B21}\u{53C2}\u{4E0E}\u{7684}\u{7FA4}\u{804A}"${e.roomName}"\u{8FD8}\u{5728}\u{8BB0}\u{5F55}\u{4E2D}\u{FF0C}\u{662F}\u{5426}\u{8981}\u{91CD}\u{65B0}\u{52A0}\u{5165}\u{FF1F}</p>
          <div class="flex justify-end space-x-2">
            <button id="cancel-rejoin" class="px-4 py-2 border border-gray-300 dark:border-gray-700 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-300">
              \u{53D6}\u{6D88}
            </button>
            <button id="confirm-rejoin" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 shadow-md hover:shadow-lg">
              \u{91CD}\u{65B0}\u{52A0}\u{5165}
            </button>
          </div>
        </div>
      `,document.body.appendChild(t),document.getElementById("cancel-rejoin").addEventListener("click",()=>{document.body.removeChild(t),s.clearLastRoom()}),document.getElementById("confirm-rejoin").addEventListener("click",async()=>{try{let n=i.value.trim()||s.getNickname();if(!n)return void alert(a("enterNickname")||"请输入昵称");s.setNickname(n);let r=document.getElementById("confirm-rejoin");r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i> 加入中...',o.getUserId()||await o.initialize(n,s.getEncryptionKey()),await o.joinRoom(e.roomId),document.body.removeChild(t),E(),k()}catch(e){console.error("重新加入群聊失败:",e),alert(e.message||"重新加入群聊失败，群聊可能已经解散"),document.body.removeChild(t),s.clearLastRoom()}})}}function E(){t.classList.add("hidden"),n.classList.remove("hidden")}function k(){let e=document.getElementById("room-name"),t=document.getElementById("room-name-input"),n=document.getElementById("room-code-display"),s=o.getRoomName()||"新加密群聊";e.textContent=s,t&&(t.value=s);let i=o.getRoomId();n&&(n.value=i),function(){let e=document.getElementById("online-count"),t=1+o.getConnectionCount();e.textContent=`${a("onlineCount")||"在线人数"}: ${t}`}()}function C(){let e=s.getChatHistory();if(!e||0===e.length)return void y.classList.add("hidden");y.classList.remove("hidden"),f.innerHTML="",e.forEach(e=>{let t=document.createElement("div");t.className="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600 transition";let n=function(e){let t=Date.now()-e;if(t<6e4)return"刚刚";if(t<36e5){let e=Math.floor(t/6e4);return`${e}\u{5206}\u{949F}\u{524D}`}if(t<864e5){let e=Math.floor(t/36e5);return`${e}\u{5C0F}\u{65F6}\u{524D}`}if(t<2592e6){let e=Math.floor(t/864e5);return`${e}\u{5929}\u{524D}`}let n=new Date(e);return`${n.getMonth()+1}\u{6708}${n.getDate()}\u{65E5}`}(e.lastActive);t.innerHTML=`
        <div class="flex-1">
          <div class="font-medium text-gray-900 dark:text-white">${e.roomName}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
            <span class="mr-2">${e.roomId}</span>
            <span>${n}</span>
          </div>
        </div>
        <div class="flex space-x-2">
          <button class="join-history-btn p-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" data-room-id="${e.roomId}">
            <i class="fas fa-sign-in-alt"></i>
          </button>
          <button class="delete-history-btn p-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" data-room-id="${e.roomId}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `,f.appendChild(t);let r=t.querySelector(".join-history-btn");r.addEventListener("click",async()=>{try{let t=i.value.trim()||s.getNickname();if(!t)return void alert(a("enterNickname")||"请输入昵称");s.setNickname(t),r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i>',o.getUserId()||await o.initialize(t,s.getEncryptionKey()),await o.joinRoom(e.roomId),E(),k()}catch(e){console.error("重新加入群聊失败:",e),alert(e.message||"重新加入群聊失败，群聊可能已经解散"),r.disabled=!1,r.innerHTML='<i class="fas fa-sign-in-alt"></i>'}}),t.querySelector(".delete-history-btn").addEventListener("click",()=>{confirm("确定要删除这个群聊记录吗？")&&(s.removeChatFromHistory(e.roomId),t.remove(),0===f.children.length&&y.classList.add("hidden"))})}),v.addEventListener("click",()=>{f.classList.contains("hidden")?(f.classList.remove("hidden"),v.innerHTML='<i class="fas fa-chevron-up"></i>'):(f.classList.add("hidden"),v.innerHTML='<i class="fas fa-chevron-down"></i>')})}p&&function(t,n){let a=t.getAllThemes(),o=t.getChatTheme(),s=document.createElement("div");s.className="mb-4";let i=document.createElement("div");i.className="block text-sm font-medium mb-2",i.textContent="聊天主题",s.appendChild(i);let r=document.createElement("div");r.className="grid grid-cols-5 gap-2",Object.keys(a).forEach(n=>{let s=a[n],i=document.createElement("button");i.className=`rounded-md p-2 border border-gray-300 dark:border-gray-700 transition hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 ${n===o?"ring-2 ring-blue-500":""}`,i.setAttribute("data-theme",n);let c=document.createElement("div");c.className="w-full h-6 rounded mb-1",c.style.background=s.headerBg,i.appendChild(c);let l=document.createElement("div");l.className="text-xs font-medium text-center",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",()=>{r.querySelectorAll("button").forEach(e=>{e.classList.remove("ring-2","ring-blue-500")}),i.classList.add("ring-2","ring-blue-500"),t.setChatTheme(n),e(t)}),r.appendChild(i)}),s.appendChild(r),n.appendChild(s)}(s,p),b(),C(),document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&!o.getRoomId()&&t.classList.contains("hidden")&&setTimeout(()=>{o.getRoomId()||(t.classList.remove("hidden"),n.classList.add("hidden"),b())},1e3)}),window.addEventListener("online",function(){o.isConnected()||document.querySelector("#confirm-rejoin")||setTimeout(()=>{b()},1e3)}),r.addEventListener("click",async()=>{let e=i.value.trim();if(!e)return void alert(a("enterNickname")||"请输入昵称");s.setNickname(e);try{r.disabled=!0,r.innerHTML='<i class="fas fa-spinner fa-spin"></i> 创建中...',await o.initialize(e,s.getEncryptionKey());let t=o.createRoom();console.log("创建了群聊:",t),s.saveChatToHistory(t,o.getRoomName()),C(),E(),k()}catch(e){console.error("创建群聊失败:",e),alert(a("createRoomFailed")||"创建群聊失败，请重试")}finally{r.disabled=!1,r.innerHTML='<i class="fas fa-plus-circle mr-2"></i> 创建群聊'}}),c.addEventListener("click",()=>{let e=i.value.trim();if(!e)return void alert(a("enterNickname")||"请输入昵称");s.setNickname(e),l.classList.remove("hidden"),d.value="",setTimeout(()=>d.focus(),100)}),m.addEventListener("click",async()=>{let e=d.value.trim();if(!e)return void alert(a("enterRoomCode")||"请输入群聊码");try{m.disabled=!0,m.innerHTML='<i class="fas fa-spinner fa-spin"></i> 加入中...',o.getUserId()||await o.initialize(s.getNickname(),s.getEncryptionKey()),console.log("尝试加入群聊:",e),await o.joinRoom(e),console.log("成功加入群聊"),s.saveChatToHistory(o.getRoomId(),o.getRoomName()),C(),l.classList.add("hidden"),E(),k()}catch(e){console.error("加入群聊失败:",e),alert(e.message||a("joinRoomFailed")||"加入群聊失败，请检查群聊码是否正确")}finally{m.disabled=!1,m.innerHTML=a("confirm")||"确认"}}),d.addEventListener("keyup",e=>{"Enter"===e.key&&m.click()}),u.addEventListener("click",()=>{l.classList.add("hidden"),d.value=""}),g.addEventListener("click",()=>{t.classList.add("hidden"),h.classList.remove("hidden")}),l.addEventListener("click",e=>{e.target===l&&l.classList.add("hidden")})}(c,l,f,g),function(e,t,n,i,r,c){let l=document.getElementById("back-btn"),d=document.getElementById("room-name"),m=document.getElementById("online-count"),u=document.getElementById("room-settings"),g=document.getElementById("messages-container"),h=document.getElementById("message-input"),p=document.getElementById("send-btn"),y=document.getElementById("file-input"),f=document.getElementById("attachment-btn"),v=document.getElementById("voice-btn"),b=document.getElementById("emoji-btn"),E=document.getElementById("emoji-container"),k=document.getElementById("scroll-bottom"),C=document.getElementById("online-users-dropdown"),L=!0,I={},w=!1,B=null,N=["\uD83D\uDE0A","\uD83D\uDC4D","\uD83C\uDF89","❤️","\uD83D\uDE02","\uD83D\uDE4F","\uD83D\uDC4B","\uD83D\uDE80"],x=!1;function T(){let e=g.scrollTop+g.clientHeight;(L=g.scrollHeight-e<10)?k.classList.add("hidden"):k.classList.remove("hidden")}(function(){let e=(e,t)=>{switch(e.type){case"chat":A(r.addMessage(e,t)),i.getRoomId()&&c.saveChatToHistory(i.getRoomId(),i.getRoomName());break;case"reaction":var n=e;n.add?r.addReaction(n.messageId,n.emoji,n.userId):r.removeReaction(n.messageId,n.emoji,n.userId);let a=g.querySelector(`[data-message-id="${n.messageId}"]`);a&&H(a.querySelector(".message-bubble"),n.messageId);break;case"host-mode":if(void 0!==e.enabled){i.isHostMode=e.enabled;let t=e.enabled?"已开启":"已关闭";F(`\u{7FA4}\u{4E3B}${t}\u{4E3B}\u{6301}\u{4EBA}\u{6A21}\u{5F0F}`),e.enabled&&!i.isCreator()&&z("主持人模式已开启，只有群主可以发送消息"),function(){let e=document.querySelector(".chat-input-container"),t=document.getElementById("message-input"),n=document.getElementById("send-btn"),a=document.getElementById("attachment-btn"),o=document.getElementById("voice-btn"),s=document.getElementById("emoji-btn");i.getHostMode()&&!i.isCreator()?(t.disabled=!0,t.placeholder="主持人模式已开启，只有群主可以发送消息",n.disabled=!0,a.disabled=!0,o.disabled=!0,s.disabled=!0,e.classList.add("opacity-75"),[n,a,o,s].forEach(e=>{e&&e.classList.add("opacity-50","cursor-not-allowed")})):(t.disabled=!1,t.placeholder="输入消息...",n.disabled=!1,a.disabled=!1,o.disabled=!1,s.disabled=!1,e.classList.remove("opacity-75"),[n,a,o,s].forEach(e=>{e&&e.classList.remove("opacity-50","cursor-not-allowed")}))}()}}};e.getHistory=()=>r.exportData(),e.setHistory=e=>{r.importData(e),g.innerHTML="",r.getAllMessages().forEach(e=>{A(e)}),O()};let t=e=>{"user-joined"===e.type&&(P(),F(`\u{6709}\u{65B0}\u{7528}\u{6237}\u{52A0}\u{5165}\u{7FA4}\u{804A}`),i.getRoomId()&&c.saveChatToHistory(i.getRoomId(),i.getRoomName()))};t.updateUserInfo=e=>{I[e.userId]={nickname:e.nickname,avatar:e.avatar},$()},t.updateRoomInfo=e=>{d.textContent=e.roomName,i.getRoomId()&&c.saveChatToHistory(i.getRoomId(),e.roomName)},i.onMessage(e),i.onConnection(t),i.onDisconnection(e=>{"user-left"===e.type&&(I[e.userId]?(F(`${I[e.userId].nickname} \u{79BB}\u{5F00}\u{4E86}\u{7FA4}\u{804A}`),delete I[e.userId]):F(`\u{7528}\u{6237}\u{79BB}\u{5F00}\u{4E86}\u{7FA4}\u{804A}`),P(),$(),i.getRoomId()&&c.updateChatLastActive(i.getRoomId()))})})(),function(){l.addEventListener("click",()=>{confirm(a("confirmExitRoom")||"确定要退出当前群聊吗？退出后将无法接收新消息")&&(i.getRoomId()&&c.saveChatToHistory(i.getRoomId(),i.getRoomName()),i.leaveRoom(!0),r.clearMessages(),g.innerHTML="",e.classList.add("hidden"),t.classList.remove("hidden"))}),u.addEventListener("click",()=>{if(!i.isCreator())return void z("只有群主可以访问群聊设置");e.classList.add("hidden"),n.classList.remove("hidden")}),p.addEventListener("click",R),h.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),R())}),y.addEventListener("change",M),f.addEventListener("click",()=>{y.click()}),v.addEventListener("click",D),b.addEventListener("click",()=>{E.classList.toggle("hidden"),document.getElementById("sticker-container").classList.add("hidden"),0===E.children.length&&N.forEach(e=>{let t=document.createElement("button");t.className="text-2xl hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md p-1",t.textContent=e,t.addEventListener("click",()=>{h.value+=e,h.focus()}),E.appendChild(t)})});let o=document.getElementById("sticker-btn");o&&o.addEventListener("click",()=>{let e=document.getElementById("sticker-container");if(!e)return void console.error("表情包容器不存在");e.classList.toggle("hidden"),E.classList.add("hidden");let t=document.getElementById("sticker-grid");t&&(!t.children||0===t.children.length||s.isFirstLoad)&&J()});let d=document.getElementById("refresh-stickers");d&&d.addEventListener("click",()=>{if(s.canRefresh()){console.log("刷新表情包..."),d.disabled=!0,J(!0);let e=()=>{let t=s.getCooldownRemaining();t>0?(d.disabled=!0,d.title=`${t}\u{79D2}\u{540E}\u{53EF}\u{518D}\u{6B21}\u{5237}\u{65B0}`,setTimeout(e,1e3)):(d.disabled=!1,d.title="刷新表情包")};e()}else{let e=s.getCooldownRemaining();d.title=`${e}\u{79D2}\u{540E}\u{53EF}\u{518D}\u{6B21}\u{5237}\u{65B0}`,z(`\u{5237}\u{65B0}\u{592A}\u{9891}\u{7E41}\u{FF0C}\u{8BF7}${e}\u{79D2}\u{540E}\u{518D}\u{8BD5}`)}}),setTimeout(()=>{try{console.log("预加载表情包..."),J(!1,!0)}catch(e){console.warn("预加载表情包失败:",e)}},3e3),k.addEventListener("click",O),g.addEventListener("scroll",T),m.addEventListener("click",()=>{C.classList.toggle("hidden")}),document.addEventListener("click",e=>{m.contains(e.target)||C.contains(e.target)||C.classList.add("hidden"),b.contains(e.target)||E.contains(e.target)||E.classList.add("hidden");let t=document.getElementById("sticker-btn"),n=document.getElementById("sticker-container");t&&n&&!t.contains(e.target)&&!n.contains(e.target)&&n.classList.add("hidden")}),h.addEventListener("input",()=>{h.style.height="auto",h.style.height=Math.min(h.scrollHeight,120)+"px"})}();let S=null;async function R(){let e=h.value.trim();if(e){if(i.getHostMode()&&!i.isCreator())return void z("主持人模式已开启，只有群主可以发送消息");try{let t=o.extractUrls(e),n={content:e,contentType:"text"};if(t.length>0)for(let e of(n.links=[],t)){let t=await o.getLinkPreview(e);n.links.push(t)}let a=await i.sendMessage(n);a&&a.encryptedPreview&&function(e){S&&clearTimeout(S);let t=document.getElementById("encryption-preview");t||((t=document.createElement("div")).id="encryption-preview",t.className="text-xs flex items-center mt-2 p-2 rounded bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-300",h.parentNode.appendChild(t));let n=e.length>20?e.substring(0,20)+"...":e;t.innerHTML=`
      <i class="fas fa-lock text-green-500 mr-2"></i>
      <div class="ml-auto text-xs opacity-70 bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">${n}</div>
    `,t.style.display="flex",S=setTimeout(()=>{t.style.display="none"},3e3)}(a.encryptedPreview),i.getRoomId()&&c.updateChatLastActive(i.getRoomId()),h.value="",h.style.height="auto",O()}catch(e){console.error("发送消息失败:",e),alert("发送消息失败，请重试")}}}async function M(){let e=y.files[0];if(e){if(i.getHostMode()&&!i.isCreator())return void z("主持人模式已开启，只有群主可以发送消息");try{let t=await o.fileToBase64(e),n={content:e.name,contentType:"file",file:{name:e.name,type:e.type,size:e.size,data:t}};await i.sendMessage(n),y.value="",O()}catch(e){console.error("发送文件失败:",e),alert("文件太大或发送失败，请重试")}}}async function D(){if(i.getHostMode()&&!i.isCreator()&&!w)return void z("主持人模式已开启，只有群主可以发送消息");if(w)w=!1,v.innerHTML='<i class="fas fa-microphone"></i>',B&&B.stop&&B.stop();else try{w=!0,v.innerHTML='<i class="fas fa-stop"></i>',(B=await o.recordVoice()).then(({blob:e,duration:t})=>{o.fileToBase64(e).then(async e=>{let n={content:`\u{8BED}\u{97F3}\u{6D88}\u{606F} (${t}\u{79D2})`,contentType:"voice",voice:{duration:t,data:e}};await i.sendMessage(n),O()})})}catch(e){console.error("录音失败:",e),alert("无法访问麦克风或录音失败"),w=!1,v.innerHTML='<i class="fas fa-microphone"></i>'}}function A(e){let t,n=document.createElement("div");n.className="flex mb-4",n.dataset.messageId=e.id;let a=e.sender.id===i.getUserId(),l=document.createElement("div");l.className="flex flex-col min-w-[50%] max-w-[90%]",a&&l.classList.add("ml-auto");let d=document.createElement("div");if(d.className=`message-bubble ${a?"message-outgoing":"message-incoming"}`,!a){let t=document.createElement("div");t.className="message-sender",t.textContent=e.sender.nickname,l.appendChild(t)}switch(e.contentType){case"text":var m=d,u=e;let h=document.createElement("p");h.textContent=u.content,m.appendChild(h),u.links&&u.links.length>0&&u.links.forEach(e=>{let t=document.createElement("div");t.className="link-preview";let n="";e.image&&(n+=`<img src="${e.image}" class="link-preview-image" alt="${e.title}">`),t.innerHTML=n+=`
                    <div class="link-preview-content">
                        <div class="link-preview-title">${e.title}</div>
                        <div class="link-preview-description">${e.description}</div>
                        <div class="link-preview-url">${e.url}</div>
                    </div>
                `,m.appendChild(t)});break;case"file":(function(e,t){let n=t.file;if(o.isImage(n.name)){let t=document.createElement("div");t.className="media-preview",t.innerHTML=`<img src="${n.data}" alt="${n.name}">`,e.appendChild(t)}else if(o.isVideo(n.name)){let t=document.createElement("div");t.className="media-preview",t.innerHTML=`
                <video controls>
                    <source src="${n.data}" type="${n.type}">
                    \u{60A8}\u{7684}\u{6D4F}\u{89C8}\u{5668}\u{4E0D}\u{652F}\u{6301}\u{89C6}\u{9891}\u{64AD}\u{653E}
                </video>
            `,e.appendChild(t)}else{let t=document.createElement("div");t.className="file-attachment";let a=document.createElement("i");a.className=`file-icon fas ${o.getFileIcon(n.name)}`;let s=document.createElement("div");s.className="file-info";let i=document.createElement("div");i.className="file-name",i.textContent=n.name;let r=document.createElement("div");r.className="file-size",r.textContent=o.formatFileSize(n.size),s.appendChild(i),s.appendChild(r);let c=document.createElement("a");c.className="file-download",c.href=n.data,c.download=n.name,c.innerHTML='<i class="fas fa-download"></i>',t.appendChild(a),t.appendChild(s),t.appendChild(c),e.appendChild(t)}})(d,e),d.className="message-bubble message-incoming";break;case"voice":(function(e,t){let n=t.voice,a=document.createElement("div");a.className="voice-message";let o=document.createElement("i");o.className="fas fa-play";let s=document.createElement("audio");s.src=n.data;let i=document.createElement("span");i.className="duration",i.textContent=`${n.duration}\u{79D2}`,a.appendChild(o),a.appendChild(i),a.appendChild(s);let r=!1;a.addEventListener("click",()=>{r?(s.pause(),o.className="fas fa-play"):(s.play(),o.className="fas fa-pause"),r=!r}),s.addEventListener("ended",()=>{o.className="fas fa-play",r=!1}),e.appendChild(a)})(d,e),d.className="message-bubble message-incoming";break;case"sticker":(function(e,t){let n=t.sticker;if(!n||!n.url){let t=document.createElement("p");t.textContent="表情包加载失败",e.appendChild(t);return}let a=document.createElement("img");a.src=(n.url.startsWith("data:")?n.url:s.cachedImageData[n.url])||n.url,a.loading="lazy",a.alt="表情包",a.dataset.id=n.id||"",a.onerror=()=>{a.style.display="none";let t=document.createElement("p");t.textContent="表情包加载失败",e.appendChild(t)},e.appendChild(a)})(d,e),d.className="message-bubble message-incoming sticker-message"}let p=document.createElement("div");p.className="message-time",p.textContent=U(e.timestamp);let y=document.createElement("div");y.className="message-actions flex items-center justify-end mt-1";let f=document.createElement("button");f.className="text-xs text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 ml-2",f.innerHTML='<i class="fas fa-copy"></i>',f.title="复制消息",f.addEventListener("click",t=>{t.stopPropagation(),q(e.content)});let v=document.createElement("span");v.className="encryption-hint text-xs text-gray-400 mr-auto opacity-60",v.innerHTML='<i class="fas fa-lock text-xs mr-1"></i>长按查看',y.appendChild(v),y.appendChild(p),y.appendChild(f),d.appendChild(y);let b=()=>{t=setTimeout(()=>{!function(e,t){let n=document.getElementById("encryption-content-popup");n&&document.body.removeChild(n);let a=r.getMessage(e.id);if(!a||!a.encryptedData)return console.warn("未找到加密数据");try{let n=document.createElement("div");if(n.id="encryption-content-popup",n.className="encryption-popup",!(window.innerWidth<=576)){let e=t.getBoundingClientRect();e.left>window.innerWidth/2?n.style.right=`${window.innerWidth-e.left}px`:n.style.left=`${e.right}px`;let a=e.top+e.height/2-100;a<10&&(a=10),a>window.innerHeight-300&&(a=window.innerHeight-300),n.style.top=`${a}px`}let o={},s="",i="";try{s=(o=JSON.parse(a.encryptedData)).ciphertext||"",i=o.iv||""}catch(e){s=a.encryptedData}n.innerHTML=`
        <div class="popup-header">
          <i class="fas fa-lock text-green-500 mr-2"></i>
          <span>\u{52A0}\u{5BC6}\u{5185}\u{5BB9}</span>
          <button class="close-btn"><i class="fas fa-times"></i></button>
        </div>
        <div class="popup-content">
          <div class="info-row"><span class="label">\u{52A0}\u{5BC6}\u{7B97}\u{6CD5}:</span> <span class="value">AES-GCM</span></div>
          ${i?`<div class="info-row"><span class="label">\u{521D}\u{59CB}\u{5411}\u{91CF}:</span> <span class="value">${i}</span></div>`:""}
          <div class="info-row"><span class="label">\u{65F6}\u{95F4}\u{6233}:</span> <span class="value">${U(e.timestamp)}</span></div>
          <div class="info-row"><span class="label">\u{53D1}\u{9001}\u{8005}:</span> <span class="value">${e.sender.nickname} (${e.sender.id})</span></div>
          <div class="cipher-header">\u{5BC6}\u{6587}\u{6570}\u{636E}:</div>
          <pre>${s}</pre>
        </div>
        <div class="popup-footer">
          <button class="copy-btn"><i class="fas fa-copy mr-1"></i>\u{590D}\u{5236}\u{5BC6}\u{6587}</button>
        </div>
      `,document.body.appendChild(n),n.querySelector(".copy-btn").addEventListener("click",()=>{q(s),n.classList.add("copying"),setTimeout(()=>{n.classList.remove("copying")},1e3)}),n.querySelector(".close-btn").addEventListener("click",()=>{document.body.removeChild(n)});let r=e=>{n.contains(e.target)||t.contains(e.target)||(document.body.contains(n)&&document.body.removeChild(n),document.removeEventListener("click",r))};setTimeout(()=>{document.addEventListener("click",r)},100)}catch(e){console.error("显示加密内容失败:",e)}}(e,d)},800)},E=()=>{clearTimeout(t)};if(d.addEventListener("mousedown",b),d.addEventListener("mouseup",E),d.addEventListener("mouseleave",E),d.addEventListener("touchstart",b),d.addEventListener("touchend",E),d.addEventListener("touchcancel",E),d.addEventListener("dblclick",()=>{!function(e){if(i.getHostMode()&&!i.isCreator())return z("主持人模式已开启，只有群主可以发送反应");let t=document.createElement("div");t.className="fixed bg-white dark:bg-gray-800 rounded-full shadow-lg p-2 flex z-10",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",["\uD83D\uDC4D","❤️","\uD83D\uDE02","\uD83D\uDE22","\uD83D\uDE21","\uD83D\uDC4F"].forEach(n=>{let a=document.createElement("button");a.className="text-2xl mx-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full p-2",a.textContent=n,a.addEventListener("click",async()=>{try{let t=await i.sendReaction(e,n,!0);t&&t.error&&z(t.error)}catch(e){console.error("发送反应失败:",e),z("发送反应失败，请重试")}document.body.contains(t)&&document.body.removeChild(t)}),t.appendChild(a)}),document.body.appendChild(t);let n=e=>{t.contains(e.target)||(document.body.contains(t)&&document.body.removeChild(t),document.removeEventListener("click",n))};setTimeout(()=>{document.addEventListener("click",n)},10)}(e.id)}),H(d,e.id),l.appendChild(d),a){n.appendChild(l);let e=document.createElement("div");e.className="flex-shrink-0 ml-2";let t=document.createElement("img");t.className="w-8 h-8 rounded-full",t.src=i.getAvatarUrl(i.getNickname()),t.alt=c.getNickname(),e.appendChild(t),n.appendChild(e)}else{let t,a=document.createElement("div");a.className="flex-shrink-0 mr-2";let o=document.createElement("img");o.className="w-8 h-8 rounded-full",o.src=e.sender.avatar||i.getAvatarUrl(e.sender.nickname),o.alt=e.sender.nickname,o.addEventListener("contextmenu",t=>{t.preventDefault(),K(e.sender.nickname,e.sender.id)}),o.addEventListener("touchstart",()=>{t=setTimeout(()=>{K(e.sender.nickname,e.sender.id)},800)}),o.addEventListener("touchend",()=>{clearTimeout(t)}),o.addEventListener("touchmove",()=>{clearTimeout(t)}),a.appendChild(o),n.appendChild(a),n.appendChild(l)}g.appendChild(n),L?O():k.classList.remove("hidden")}function H(e,t){let n=e.querySelector(".message-reactions");n&&n.remove();let a=r.getMessageReactions(t);if(!a||0===Object.keys(a).length)return;let o=document.createElement("div");o.className="message-reactions",Object.keys(a).forEach(e=>{let n=a[e],s=document.createElement("div");s.className="reaction",r.hasUserReacted(t,e,i.getUserId())&&s.classList.add("selected"),s.innerHTML=`
                <span class="reaction-emoji">${e}</span>
                <span class="reaction-count">${n}</span>
            `,s.addEventListener("click",async()=>{if(i.getHostMode()&&!i.isCreator())return void z("主持人模式已开启，只有群主可以发送反应");try{if(r.hasUserReacted(t,e,i.getUserId())){let n=await i.sendReaction(t,e,!1);n&&n.error&&z(n.error)}else{let n=await i.sendReaction(t,e,!0);n&&n.error&&z(n.error)}}catch(e){console.error("处理反应失败:",e),z("处理反应失败，请重试")}}),o.appendChild(s)}),e.appendChild(o)}function F(e){let t=document.createElement("div");t.className="text-center text-xs text-gray-500 dark:text-gray-400 my-2",t.textContent=e,g.appendChild(t)}function $(){let e=document.getElementById("users-list");e&&(e.innerHTML="",j(e,{userId:i.getUserId(),nickname:c.getNickname(),avatar:i.getAvatarUrl(i.getNickname())},!0),Object.keys(I).forEach(t=>{I[t]&&j(e,{userId:t,nickname:I[t].nickname,avatar:I[t].avatar})}),P())}function j(e,t,n=!1){let a=document.createElement("li");a.className="user-item";let o=document.createElement("img");o.className="user-avatar",o.src=t.avatar,o.alt=t.nickname;let s=document.createElement("span");s.className="user-name",s.textContent=t.nickname+(n?" (你)":""),a.appendChild(o),a.appendChild(s),e.appendChild(a)}function P(){let e=i.getConnectionCount()+1;m.textContent=`\u{5728}\u{7EBF}\u{4EBA}\u{6570}: ${e}`,e<3&&F("当在线人数不足3人时，群聊将在最后一人退出后被摧毁")}function O(){g.scrollTop=g.scrollHeight,k.classList.add("hidden"),L=!0}function U(e){let t=new Date(e),n=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0");return`${n}:${a}`}function K(e,t){let n=`@${e} `;h.value+=n,h.focus();let a=document.createElement("div");a.className="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-50",a.textContent=`\u{5DF2}\u{6DFB}\u{52A0}@${e}`,document.body.appendChild(a),setTimeout(()=>{document.body.removeChild(a)},2e3)}function q(e){if(e)try{let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),z("复制成功")}catch(e){console.error("复制失败:",e),z("复制失败，请重试")}}function z(e,t=2e3){let n=document.querySelector(".chat-toast");n&&document.body.removeChild(n);let a=document.createElement("div");a.className="chat-toast",a.textContent=e,document.body.appendChild(a),setTimeout(()=>a.classList.add("show"),10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},300)},t)}async function J(e=!1,t=!1){if(x&&!e)return;let n=document.getElementById("sticker-grid"),a=document.getElementById("sticker-count"),o=document.getElementById("refresh-stickers");if(!n)return void console.error("无法找到表情包容器元素");x=!0,o&&(o.disabled=!0),t||(n.innerHTML='<div class="sticker-loading"><i class="fas fa-spinner fa-spin mr-2"></i>正在加载表情包...</div>');try{console.log("开始加载表情包...");let e=await s.fetchStickers();if(console.log("获取到表情包数据:",e.length),!document.getElementById("sticker-grid"))return void console.warn("加载过程中表情包容器已被移除");if(t&&n.children&&n.children.length>1){console.log("静默加载完成，保留现有表情包"),x=!1,o&&setTimeout(()=>{o.disabled=!s.canRefresh()},100);return}n.innerHTML="",e&&0!==e.length?e.forEach(e=>{if(!e||!e.url)return;let t=document.createElement("div");t.className="sticker-item",t.dataset.id=e.id||`sticker-${Date.now()}`;let a=document.createElement("img");a.src=e.url,a.loading="lazy",a.alt="表情包",a.onerror=()=>{a.style.display="none",t.innerHTML='<div class="flex items-center justify-center h-full text-xs text-gray-500">加载失败</div>'},t.addEventListener("click",()=>{let t=document.getElementById("sticker-container");t&&t.classList.add("hidden"),W(e.url,e.id)}),t.appendChild(a),n.appendChild(t)}):n.innerHTML='<div class="sticker-loading">暂无表情包，请刷新重试</div>',a&&(a.textContent=`(${e?e.length:0})`)}catch(e){console.error("加载表情包失败:",e),n&&!t&&(n.innerHTML='<div class="sticker-loading text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>加载失败，请重试</div>'),t||z("加载表情包失败，请稍后重试")}finally{x=!1,setTimeout(()=>{o&&(o.disabled=!s.canRefresh(),console.log("刷新按钮状态:",o.disabled?"禁用":"启用"))},100)}}async function W(e,t){if(i.getHostMode()&&!i.isCreator())return void z("主持人模式已开启，只有群主可以发送消息");try{let n={content:"表情包",contentType:"sticker",sticker:{url:e,id:t||`sticker-${Date.now()}`}};await i.sendMessage(n),i.getRoomId()&&c.updateChatLastActive(i.getRoomId()),O()}catch(e){console.error("发送表情包失败:",e),z("发送表情包失败，请重试")}}}(l,c,m,f,y,g);const b=document.getElementById("back-from-settings"),E=document.getElementById("settings-toggle-theme"),k=document.getElementById("language-select");function C(e,t=3e3){let n=document.querySelector(".toast");n&&document.body.removeChild(n);let a=document.createElement("div");a.className="toast",a.textContent=e,document.body.appendChild(a),setTimeout(()=>{a.classList.add("show")},10),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},500)},t)}b.addEventListener("click",()=>{d.classList.add("hidden"),c.classList.remove("hidden")}),E.addEventListener("click",()=>{let e=document.documentElement.classList.toggle("dark");g.setDarkMode(e);let t=E.querySelector("span");e?(t.classList.add("left-5"),t.classList.remove("left-0"),E.classList.add("bg-blue-600"),E.classList.remove("bg-gray-300")):(t.classList.remove("left-5"),t.classList.add("left-0"),E.classList.remove("bg-blue-600"),E.classList.add("bg-gray-300"))}),k.addEventListener("change",e=>{let t=e.target.value;g.setLanguage(t),window.location.reload()}),function(){let e=g.getDarkMode(),t=E.querySelector("span");e?(document.documentElement.classList.add("dark"),t.classList.add("left-5"),t.classList.remove("left-0"),E.classList.add("bg-blue-600"),E.classList.remove("bg-gray-300")):(document.documentElement.classList.remove("dark"),t.classList.remove("left-5"),t.classList.add("left-0"),E.classList.remove("bg-blue-600"),E.classList.add("bg-gray-300")),k.value=g.getLanguage()}(),function(e,t,n,a){let o=document.getElementById("back-from-room-settings"),s=document.getElementById("room-name-input"),i=document.getElementById("room-code-display"),r=document.getElementById("copy-room-code"),c=document.getElementById("leave-room"),l=document.getElementById("host-mode-toggle");o.addEventListener("click",()=>{let a=s.value.trim();a&&a!==n.getRoomName()&&(n.setRoomName(a),document.getElementById("room-name").textContent=a),e.classList.add("hidden"),t.classList.remove("hidden")}),r.addEventListener("click",()=>{let e=i.value;e&&navigator.clipboard.writeText(e).then(()=>{let e=r.innerHTML;r.innerHTML='<i class="fas fa-check"></i>',setTimeout(()=>{r.innerHTML=e},2e3)}).catch(e=>{console.error("复制失败:",e)})}),c.addEventListener("click",()=>{confirm("确定要离开群聊吗？")&&(n.leaveRoom(!0),e.classList.add("hidden"),t.classList.add("hidden"),document.getElementById("home-page").classList.remove("hidden"))}),s.addEventListener("input",()=>{document.getElementById("room-name").textContent=s.value||"群聊名称"}),l&&l.addEventListener("click",async()=>{if(!n.isCreator())return void alert("只有群主可以设置主持人模式");let e=l.classList.contains("bg-blue-600");e?(l.classList.remove("bg-blue-600"),l.classList.add("bg-gray-300"),l.querySelector("span").style.left="0",await n.setHostMode(!1)):(l.classList.remove("bg-gray-300"),l.classList.add("bg-blue-600"),l.querySelector("span").style.left="20px",await n.setHostMode(!0));var t=e?"已关闭主持人模式":"已开启主持人模式，只有群主可以发送消息";if("function"==typeof window.showToast)window.showToast(t);else{let e=document.createElement("div");e.className="toast",e.textContent=t,document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),10),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>document.body.removeChild(e),500)},3e3)}}),new MutationObserver(t=>{t.forEach(t=>{"attributes"!==t.type||"class"!==t.attributeName||e.classList.contains("hidden")||function(){if(s.value=n.getRoomName()||"新加密群聊",i.value=n.getRoomId(),l){let e=n.isCreator();if(l.closest(".mb-4"),e)l.disabled=!1,l.classList.remove("opacity-50","cursor-not-allowed");else{l.disabled=!0,l.classList.add("opacity-50","cursor-not-allowed");let e=l.parentElement.nextElementSibling;e&&(e.textContent="只有群主可以设置主持人模式")}n.getHostMode()?(l.classList.remove("bg-gray-300"),l.classList.add("bg-blue-600"),l.querySelector("span").style.left="20px"):(l.classList.remove("bg-blue-600"),l.classList.add("bg-gray-300"),l.querySelector("span").style.left="0")}}()})}).observe(e,{attributes:!0})}(m,l,f,0),document.addEventListener("DOMContentLoaded",function(){window.peerManager=new r;let e=!localStorage.getItem("appFirstLaunch"),t=g.getNickname();if(document.getElementById("nickname").value=t,!localStorage.getItem(g.keys.nickname)&&!localStorage.getItem("hasGeneratedNickname")){let e=document.createElement("div");e.className="loading-overlay",e.innerHTML='<div class="loading-spinner"></div><div class="loading-text">正在为你生成个人信息...</div>',document.body.appendChild(e),document.addEventListener("nicknameGenerated",function(t){let n=t.detail.nickname;console.log("昵称生成完成:",n),document.getElementById("nickname").value=n,localStorage.getItem("nicknameNotified")||(C(`\u{5DF2}\u{4E3A}\u{60A8}\u{81EA}\u{52A8}\u{751F}\u{6210}\u{6635}\u{79F0}: ${n}`),localStorage.setItem("nicknameNotified","true")),e.classList.add("fade-out"),setTimeout(()=>{document.body.removeChild(e)},500)}),setTimeout(()=>{document.contains(e)&&(console.warn("昵称生成超时，移除遮罩"),document.body.removeChild(e),C("个人信息生成遇到问题，您可以手动设置昵称"))},5e3)}e&&setTimeout(()=>{let e=document.getElementById("welcome-modal"),t=document.getElementById("welcome-ok");e.classList.remove("hidden"),localStorage.setItem("appFirstLaunch","true"),t.addEventListener("click",()=>{e.classList.add("hidden")}),e.addEventListener("click",t=>{t.target===e&&e.classList.add("hidden")})},1e3),window.unreadCount=0,window.isPageVisible=!document.hidden}),window.showToast=C;
